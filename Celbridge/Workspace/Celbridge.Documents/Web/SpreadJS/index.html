<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Celbridge Spreadsheet</title>

    <link rel="stylesheet" href="lib/spreadjs/css/gc.spread.sheets.excel2013white.18.1.4.css" />
    <link rel="stylesheet" href="lib/designer/css/gc.spread.sheets.designer.18.1.4.min.css" />

    <style>
        /* remove all spacing around the SpreadJS container */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* avoid scrollbars from 100vh, optional */
        }

        /* make the designer fill the viewport exactly */
        #gc-designer-container {
            position: fixed;
            inset: 0;
        }

        .spreadjs-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            pointer-events: none;
            font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .spreadjs-badge a {
            pointer-events: auto;
            text-decoration: none;
        }
    </style>

</head>

<body unselectable="on">
    <div id="gc-designer-container" role="application" style="width:100%; height:100vh;"></div>

    <div class="spreadjs-badge" aria-label="Powered by SpreadJS">
        Powered by <a href="https://developer.mescius.com/spreadjs" target="_blank" rel="noopener">SpreadJS</a>
    </div>

    <script src="lib/spreadjs/scripts/gc.spread.sheets.all.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.shapes.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.charts.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.datacharts.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.slicers.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.print.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.barcode.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.pdf.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.pivot.pivottables.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.tablesheet.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.ganttsheet.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.formulapanel.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.report.reportsheet.18.1.4.min.js"></script>
    <script src="lib/spreadjs/scripts/plugins/gc.spread.sheets.io.18.1.4.min.js"></script>

    <script src="lib/designer/scripts/gc.spread.sheets.designer.resource.en.18.1.4.min.js"></script>
    <script src="lib/designer/scripts/gc.spread.sheets.designer.all.18.1.4.min.js"></script>

    <script src="lib/license.js"></script>

    <script>
        function listenForWebViewMessages() {
            if (!window.isWebView) return;

            if (window.chrome?.webview) {
                chrome.webview.addEventListener('message', event => onWebViewMessage(event.data));
            } else if (window.unoWebView) {
                window.unoWebViewReceiveMessage = data => onWebViewMessage(data);
            } else if (window.webkit?.messageHandlers) {
                window.webkit.messageHandlers.unoWebViewReceiveMessage = data => onWebViewMessage(data);
            }
        }

        function postWebViewMessage(message) {
            if (!window.isWebView) return;

            try {
                if (window.chrome?.webview) {
                    chrome.webview.postMessage(message);
                } else if (window.unoWebView) {
                    unoWebView.postMessage(JSON.stringify(message));
                } else if (window.webkit?.messageHandlers?.unoWebView) {
                    window.webkit.messageHandlers.unoWebView.postMessage(JSON.stringify(message));
                }
            } catch (ex) {
                console.error('WebView postMessage failed:', ex);
            }
        }

        function onWebViewMessage(webViewMessage) {

            // The C# side handles the automatic save timer logic, sending a "request_save" message when a
            // save should be performed. On the JS side, we serialize the spreadsheet to base 64 and send it back in response.
            if (webViewMessage == "request_save") {
                serializeExcelData();
                return;
            }

            // Assume that any other message contains base 64 encoded Excel data to be edited in SpreadJS.
            deserializeExcelData(webViewMessage)
        }

        async function deserializeExcelData(base64Data) {
            if (!window.isWebView) return;

            try {
                const binary = atob(base64Data);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

                const blob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const file = new File([blob], 'imported.xlsx', { type: blob.type });

                const spread = window.designer.getWorkbook();

                await spread.import(file, () => {
                    GC.Spread.Sheets.Designer.setWorkbook(spread);
                    console.log("Excel imported from base64.");
                }, console.error, {
                    fileType: GC.Spread.Sheets.FileType.excel
                });
            } catch (err) {
                console.error("Import failed:", err);
            }
        }

        async function serializeExcelData() {
            const spread = window.designer.getWorkbook();
            try {
                spread.export(async (blob) => {
                    const base64 = await blobToBase64(blob);
                    postWebViewMessage(base64);
                    console.log("Exported workbook");
                }, console.error, {
                    fileType: GC.Spread.Sheets.FileType.excel
                });
            } catch (err) {
                console.error("Export failed:", err);
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function listenForChanges() {
            const workbook = window.designer.getWorkbook();
            commandManager = workbook.commandManager();

            // SpreadJS doesn't have a unified way to detect when the spreadsheet is modified, but as all
            // modifications are performed via the command system we can just listen for any executing commands and
            // assume that the data has changed.
            // https://developer.mescius.com/forums/spreadjs/how-to-detect-if-there-is-any-modification-in-spreadjs
            commandManager.addListener('appListener', (args) => {
                postWebViewMessage("data_changed")
            });
        }

        window.onload = function () {

            // Apply license keys
            GC.Spread.Sheets.LicenseKey = SPREAD_JS_LICENSE_KEY;
            GC.Spread.Sheets.Designer.LicenseKey = SPREAD_JS_DESIGNER_LICENSE_KEY;

            const config = GC.Spread.Sheets.Designer.DefaultConfig;
            delete config.fileMenu;

            // Custom save / load buttons
            // These are no longer required since I implemented auto save, but keeping the code here for future reference.
            //config.ribbon[0].buttonGroups.unshift({
            //    label: "File",
            //    commandGroup: {
            //        children: [
            //            { direction: "vertical", commands: ["cmdLoadData", "cmdSaveData"] },
            //        ]
            //    }
            //});

            //config.commandMap = {
            //    cmdLoadData: {
            //        title: "Load Excel File",
            //        text: "Load",
            //        bigButton: false,
            //        iconClass: "ribbon-button-loadschema",
            //        execute: loadExcelData
            //    },
            //    cmdSaveData: {
            //        title: "Save Excel File",
            //        text: "Save",
            //        bigButton: false,
            //        iconClass: "ribbon-button-saveschema",
            //        execute: saveExcelData
            //    }
            //};

            const designer = new GC.Spread.Sheets.Designer.Designer(
                document.getElementById("gc-designer-container"), config
            );

            window.designer = designer;

            listenForWebViewMessages();
            listenForChanges();
            postWebViewMessage("editor_ready");
        };
    </script>
</body>

</html>
